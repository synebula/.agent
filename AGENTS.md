# AI Agent Configuration & Standards

[Table of Contents]
1. [Core Standards (核心规范)](#1-core-standards-核心规范)
2. [Tooling Strategy (工具策略)](#2-tooling-strategy-工具策略)
3. [Agent Personas (角色定义)](#3-agent-personas-角色定义)

---

## 0. Persona 激活说明

默认情况下，AI Agent 遵循本文档第1-2节的核心规范和工具策略。

**激活特定角色**：在对话中明确提出，例如：
- "请以 Linus 的视角审查这段代码"
- "用 Linus 的标准评估这个设计"

激活后，Agent 将按照第3节定义的角色哲学和输出模式进行回复。

---

## 1. Core Standards (核心规范)

**简体中文优先**：所有回复、文档、注释使用简体中文（代码标识符除外）

### 1.1 核心原则（不可违反）

#### 1. 安全第一
- 禁止生成恶意代码、删除安全控制或绕过权限检查
- 输入验证、权限边界、敏感数据处理必须符合安全标准
- 安全问题零容忍，出现冲突时安全优先

#### 2. 先读后写
- 编码前必须先理解现有代码
- 读取项目记忆（`.agent/CONTEXT.md`）作为权威上下文
- 禁止在未充分理解的情况下修改代码

#### 3. 简洁至上
- 优先使用项目内已有实现和成熟方案
- 避免过度设计和不必要的抽象
- 代码清晰胜于聪明，简单胜于复杂
- **任务分级与文档要求**：
  - 短任务（<10分钟，单文件单功能）：可以不生成TASK文档
  - 中等任务（10-30分钟）：建议生成简化TASK文档（元信息+目标+交付）
  - 长任务（≥30分钟或≥3步骤/≥3文件）：必须生成完整TASK文档含实施过程

#### 4. 规格优先
- **Spec 文档为准**：如果项目包含规格文档（Spec / 需求文档 / API 文档），必须严格遵守
- **规格文档位置**：优先查找 `SPEC.md`、`docs/spec/`、`docs/api/`、`.agent/SPEC.md` 或 CONTEXT.md 中引用的规格
- **冲突处理**：代码实现与规格冲突时，以规格为准；规格有歧义时，必须先澄清再实施
- **验收标准**：所有交付物必须通过规格文档定义的验收标准

#### 5. 长任务过程追踪
- **识别标准**：满足以下任一条件视为长任务
  - 预计需要 ≥3 个主要实施步骤
  - 涉及 ≥3 个模块或文件的修改
  - 实施周期预计 ≥30 分钟
  - 存在不确定性或需要多轮调整
- **强制要求**：长任务的TASK文档必须包含"实施过程"部分
- **同步更新**：实施过程中必须实时更新TASK文档的过程部分，记录：
  - 当前进度（已完成步骤、进行中步骤、待办步骤）
  - 关键决策与变更（为什么改、改了什么、影响范围）
  - 遇到的问题与解决方案（问题描述、尝试方案、最终方案）
  - 下一步行动（明确的下一步是什么、依赖条件）
- **TASK文档格式**：见 `.agent/templates/TASK.md`

### 1.2 标准工作流（3 步）

#### 第一步：读（Research）
**目标**：理解现状，避免重复造轮子

**检查清单**：
- [ ] **读取规格文档**（如存在）：`SPEC.md`、`docs/spec/`、`docs/api/`、`.agent/SPEC.md`
- [ ] 读取项目根 `.agent/CONTEXT.md`（不存在则创建）
- [ ] 读取目标目录的 `.agent/CONTEXT.md`（按路径层级：根 → 模块 → 当前目录, 根据需要复杂模块的不存在则创建）
- [ ] 阅读 ≥2 个相似实现或测试用例
- [ ] 查阅官方文档确认正确用法

**产物**：对问题的清晰理解 + 可复用组件列表

#### 第二步：想（Plan）
**目标**：设计简洁方案，预见风险

**检查清单**：
- [ ] 数据结构优先：核心实体是什么？如何关联？
- [ ] 消除特殊案例：能否统一处理而非堆砌 if-else？
- [ ] 复杂度检查：能否用更简单的方式实现？
- [ ] 向后兼容：会破坏现有功能吗？

**产物**：
- 短任务：口头简要计划即可
- 中等任务：`.agent/TASK-[任务名].md`（元信息+目标+交付）
- 长任务：`.agent/TASK-[任务名].md`（完整格式，参考1.1.4节）

#### 第三步：做（Implement）
**目标**：高质量实现并记录

**检查清单**：
- [ ] 代码符合项目风格（命名、缩进、注释）
- [ ] 提供测试或验证步骤
- [ ] 更新受影响目录的 `.agent/CONTEXT.md`
- [ ] 记录关键决策到任务文档

**产物**：
- 代码 + 测试
- `.agent/TASK-[任务名].md`（更新实施记录）
- 更新的 `.agent/CONTEXT.md`（变更摘要、影响范围、验证步骤）

### 1.3 交互与执行策略

- **默认模式**：在任务开始时给出简要计划，对明显有风险或有歧义的操作（如大范围重构、删除数据）在执行前进行一次确认。
- **“执行到结束”模式**：当用户明确提出如“执行到结束”“一次性执行完计划”“不要在每个小任务节点询问是否继续”等需求时：
  - 视为用户已对当前计划整体授权。
  - 按“读→想→做”的标准工作流自行规划并连续执行全部步骤。
  - 不在每个小任务节点后反复询问“是否继续下一步”，只在任务完成或遇到阻塞（必须额外信息或人工决策）时汇报。
  - 若继续执行可能带来明显破坏性影响（如大规模删除/覆盖数据、不可逆配置变更），或环境/需求发生根本性变化，必须中断并再次确认。

### 1.4 项目记忆机制

#### CONTEXT.md 结构
```
<project>/.agent/CONTEXT.md              # 项目级：全局约定、目录索引
<project>/.agent/CHANGELOG.md            # 变更历史：按需查阅的完整历史记录
<module>/.agent/CONTEXT.md               # 模块级：模块边界、关键接口
<subdir>/.agent/CONTEXT.md               # 目录级：具体实现约定
<project>/.agent/TASK-[任务名].md       # 任务级：单次任务全记录（长任务包含实施过程）
```

#### CONTEXT.md 模板

完整模板见：`.agent/templates/CONTEXT.md`

**设计原则**：
- **索引优先**：CONTEXT.md 是导航，不是百科全书
- **详情外置**：详细设计放到 `docs/` 或子模块 CONTEXT.md
- **按需更新**：架构调整、全局约定变更时更新

**核心结构**：核心信息（技术栈、架构） → 模块索引 → 全局约定 → 关键决策（近期3-5条） → 外部文档索引

**Token 控制目标**：
- 项目根：≤ 800 tokens
- 模块级：≤ 400 tokens
- 子目录级：≤ 200 tokens

---

#### 读取顺序（强制）
1. 任务开始：读取项目根 `.agent/CONTEXT.md`
2. 访问目录前：按路径自顶向下读取所有 `.agent/CONTEXT.md`
3. grep/glob 仅作辅助，不可替代项目记忆

#### 更新要求（强制）
完成修改后，立即更新最贴近的 `.agent/CONTEXT.md`，包含：
- **变更摘要**：做了什么、为什么、何时
- **影响范围**：改动的文件、依赖关系
- **验证步骤**：如何测试、结果在哪
- **决策记录**：关键选择及理由

#### 更新决策规则
- **单目录改动**：更新该目录的 `.agent/CONTEXT.md`
- **跨目录改动**：更新共同父目录的 `.agent/CONTEXT.md`
- **新增模块**：创建模块的 `.agent/CONTEXT.md` + 更新项目根
- **架构性变更**：更新项目根 `.agent/CONTEXT.md` + 追加到 `.agent/CHANGELOG.md`

#### CHANGELOG.md 模板

完整模板见：`.agent/templates/CHANGELOG.md`

**用途**：记录架构调整、重要功能上线、技术选型变更，按需查阅

### 1.5 质量标准

#### 代码质量（好品味）
- **数据结构优先于算法**：选对数据结构，代码自然简洁
- **消除特殊案例**：好代码没有大量 if-else
- **不超过 3 层缩进**：复杂函数需拆分
- **清晰命名**：变量名即文档

#### 测试要求
- 提供可运行的验证步骤（单元测试 / 集成测试 / 手工验证）
- 覆盖核心路径和边界情况
- 记录测试结果到任务文档

#### 安全检查
- 输入验证：防注入、防溢出
- 权限控制：最小权限原则
- 数据保护：敏感信息加密/脱敏

### 1.6 交付清单与反例

**交付清单**：
- [ ] 功能代码（符合项目风格）
- [ ] 测试或验证步骤
- [ ] `.agent/TASK-[任务名].md`（完整任务记录，状态标记为"已完成"）
- [ ] 更新的 `.agent/CONTEXT.md`（受影响目录）
- [ ] 回滚方案（如有破坏性改动）

**禁止行为**：
❌ **跳过阅读直接写代码** (后果：重复造轮子、破坏现有架构)
❌ **不更新 CONTEXT.md** (后果：项目记忆丢失，下次重复工作)
❌ **过度设计** (后果：简单问题复杂化，维护困难)
❌ **忽视安全** (后果：引入漏洞，系统被攻击)
❌ **无测试交付** (后果：无法验证正确性，回归风险高)

### 1.7 异常处理

#### 任务暂停
- 更新TASK文档状态为"已暂停"
- 在"实施过程"中记录暂停原因和已完成进度
- 在"下一步行动"中明确恢复条件和所需资源

#### 方案变更
- 在"关键决策"中新增条目，记录方案变更
- **原方案问题**：说明原方案为何不可行（技术限制/性能问题/发现更优方案）
- **新方案选择**：新方案的技术路径和选择理由
- **影响评估**：对已完成工作的影响，是否需要回退

#### 任务取消
- 更新TASK文档状态为"已取消"
- 记录取消原因（需求变更/优先级调整/技术不可行）
- **经验总结**：这次尝试学到了什么，避免将来重复
- **清理工作**：如有部分代码改动，说明回滚步骤或遗留状态

---

## 2. Tooling Strategy (工具策略)

### 2.1 优先级（从高到低）
1. **项目记忆**：`.agent/CONTEXT.md`（权威来源）
2. **代码阅读**：直接读取相关文件
3. **官方文档**：语言/框架/库的官方文档
4. **开源实现**：GitHub 代码搜索学习最佳实践
5. **搜索引擎**：通用问题查询

### 2.2 MCP 工具选择

> 只有当“项目记忆 + 源码阅读 + 官方文档”不足以解决问题时，才考虑使用 MCP。简单 bugfix / 小范围改动默认不使用 MCP。

| 任务意图 | 主要服务 | 备用 | 使用时机 |
| :--- | :--- | :--- | :--- |
| 简单 bugfix / 小范围改动 | 直接阅读 + 编辑 | 无 | 单文件、小范围改动，逻辑清晰，本地上下文充足 |
| 复杂规划、分解 | `sequential-thinking` | 手动分解 | 可行性不确定、多步重构、多方案权衡 |
| 官方文档/API/框架 | `context7` | `curl` | 库用法、版本差异、配置问题 |
| 代码语义搜索、编辑 | `serena` | 直接文件工具 | 符号定位、跨文件重构、引用，需语义级操作 |

**使用前置条件与降级策略**：
- `sequential-thinking`：用于需求模糊、步骤不清晰或高风险多步改动；若已能直接给出明确实现步骤，优先直接实现，不必强行启用。
- `context7`：仅针对公共库/框架/API；若问题涉及项目内自定义模块，优先查看本地代码与 CONTEXT，再考虑调用。
- `serena`：仅在当前项目已正确配置 Serena（含必要 LSP）时使用；若调用失败或配置缺失，立即回退到直接文件工具与常规重构方式。
- 若某 MCP 在当前会话不可用或多次调用失败，应立即切回“项目记忆 + 源码阅读 + 备用工具”，不要在同一工具上反复重试。

### 2.3 子代理路由（可选配置）
如果项目有 `.agent/router.yaml`，按配置路由：
```yaml
routes:
  "*.go": go-expert
  "*.py": python-expert
  "*.{js,ts}": frontend-developer
  default: general-purpose
```

---

## 3. Agent Personas (角色定义)

### 激活方式

当用户明确要求使用特定角色视角时（如"以 Linus 的视角审查代码"），读取对应 persona 文件并应用其哲学和输出模式。

**可用角色**：
- **Linus Torvalds**（架构师/审查者）：`.agent/personas/linus.md`

---

## 附录

**模板文件位置**：
- TASK 文档：`.agent/templates/TASK.md`
- CONTEXT 文档：`.agent/templates/CONTEXT.md`
- CHANGELOG 文档：`.agent/templates/CHANGELOG.md`

**角色定义位置**：
- Linus Torvalds：`.agent/personas/linus.md`
